<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>gKréta - Dashboard</title>
        <script>window.$ = window.jQuery = require("./modules/jquery-3.2.1.min.js");</script>
        <script>require("./modules/titlebar.js");</script>
        <link rel="stylesheet" type="text/css" href="./css/general-dark.css" />
    </head>
    <body>
        <div id="title-bar-bg">
            <div id="title-bar">
                <div id="title"><script>document.write(document.title)</script></div>
                <div id="title-bar-btns">
                        <button id="min-btn" class="title-bar-btn">-</button>
                        <button id="max-btn" class="title-bar-btn">+</button>
                        <button id="close-btn" class="title-bar-btn">x</button>
                </div>
            </div>
        </div>
        <div id="mySidenav" class="sidenav">
                <a onclick="onNavClick('Dashboard')">Dashboard</a>
                <a onclick="onNavClick('Evaluations')">Evaluations</a>
                <a onclick="onNavClick('Timetable')">Timetable</a>
                <a onclick="onNavClick('Absences')">Absences</a>
                <a onclick="onNavClick('Settings')">Settings</a>
        </div>
        <div id="content">  
            <script>
                var ipc=require("electron").ipcRenderer;
                var isErrorPage = false;
                var studentData = "";
                ipc.send('getStudentDataAndSendToRenderer');
                ipc.on("gotStudentData", function studentDataHandler(event,studentDataL) {
                    studentData = studentDataL;
                    var h1Name = $("<h1 style='margin-top: 30px;'>" + studentData.Name + "<h1/>");
                    var hr = $("<hr />")
                    var tabDiv = $("<div id='tabDiv' />")
                    h1Name.appendTo('#content');
                    hr.appendTo('#content');
                    tabDiv.appendTo('#content');
                    onNavClick('Dashboard')
                    ipc.removeListener("gotStudentData", studentDataHandler);
                });

                ipc.on("gotError", function errorDataHandler(event, errorCode) {
                    displayErrorTab(errorCode); 
                    ipc.removeListener("gotError", errorDataHandler);
                });

                function capitalizeFirstLetter(string) {
                    return string.charAt(0).toUpperCase() + string.slice(1);
                }

                function onNavClick(tab) {
                    document.title = "gKréta - " + tab;
                    $('#title').empty();
                    $('#title').html(document.title);

                    if (!isErrorPage) {
                        displayTab(tab);
                    }
                }

                function displayErrorTab(errorCode) {
                    var h1Name = $("<h1 style='margin-top: 30px; color: #a30404;'>Error " + errorCode + "<h1/>");
                    var hr = $("<hr />")
                    var tabDiv = $("<div id='tabDiv' />")
                    var errorDescH2 = $("<h2>What does this mean?<h2/>");
                    switch (errorCode) {
                        case 403: {
                            var errorDesc = $("<p>KRÉTA servers are under maintenance. We got an unauthorized access error.<p/>");
                            break;
                        }

                        case 503: {
                            var errorDesc = $("<p>KRÉTA servers are under maintenance. In theory it's a planned maintenance.<p/>");
                            break;
                        }

                        default: {
                            var errorDesc = $("<p>Unknown error. Report the error code to the developer. (thegergo02@protonmail.com or github.com/thegergo02)<p/>");
                            break;
                        }
                    }
                    h1Name.appendTo('#content');
                    hr.appendTo('#content');
                    tabDiv.appendTo('#content');
                    errorDescH2.appendTo('#tabDiv');
                    errorDesc.appendTo('#tabDiv');
                    isErrorPage = true;
                }

                function displayTab(tab) {
                    switch(tab) {
                        case "Dashboard": {
                            $("#tabDiv").empty();
                            $("#tabDiv").html("<h2>" + tab + "</h2>");
                            break;
                        }
                        
                        case "Evaluations": {
                            $("#tabDiv").empty();
                            $("#tabDiv").html("<h2>" + tab + "</h2>");
                            var evals = studentData.Evaluations;   
                            var subjects = new Array();

                            for(let i = 0; i < Object.keys(evals).length; i++) {
                                var currentSub = evals[i].Subject;
                                if (subjects.indexOf(currentSub) === -1 && currentSub !== null) {
                                    subjects.push(currentSub);
                                }
                            }

                            for (j = 0;j < Object.keys(subjects).length;j++) {
                                $("<h2 id='h2" + j + "'><b>" + capitalizeFirstLetter(subjects[j]) + "</b></h2>").appendTo("#tabDiv");
                                for (i = 0;i < Object.keys(evals).length;i++) {
                                    if (evals[i].Subject === subjects[j]) {
                                        switch (evals[i].NumberValue) {
                                            case 5: {
                                                var evalColor = "#03a338";
                                                break;
                                            }
                                            case 4: {
                                                var evalColor = "#bed300";
                                                break;
                                            }
                                            case 3: {
                                                var evalColor = "#ed5300";
                                                break;
                                            }
                                            case 2: {
                                                var evalColor = "#ff0202";
                                                break;
                                            }
                                            case 1: {
                                                var evalColor = "#820000";
                                                break;
                                            }
                                            default: {
                                                var evalColor = "#820000";
                                                break;
                                            }
                                        }

                                        var currentEval = "<p><span id='spanEval" + i + "' style='color: " + evalColor + ";'>" + evals[i].Value + "</span>"; 

                                        if (evals[i].Mode !== "" && evals[i].Mode !== null)
                                            currentEval += " | " + evals[i].Mode;

                                        if (evals[i].Theme !== "" && evals[i].Theme !== null)
                                            currentEval += " | " + evals[i].Theme;

                                        currentEval = $(currentEval + "</p>");
                                        currentEval.appendTo("#tabDiv");
                                    }
                                }
                            }
                            break;
                        }

                        case "Timetable": {
                            $("#tabDiv").empty();
                            $("#tabDiv").html("<h2>" + tab + "</h2>");
                            break;
                        }

                        case "Absences": {
                            $("#tabDiv").empty();
                            $("#tabDiv").html("<h2>" + tab + "</h2>");                            
                            break;
                        }

                        case "Settings": {
                            $("#tabDiv").empty();
                            $("#tabDiv").html("<h2>" + tab + "</h2>");                            
                            break;
                        }

                        default: {
                            console.log(tab, " oof default case?!!");
                            break;
                        }
                    }
                }
            </script>
        </div>
    </body>
</html>